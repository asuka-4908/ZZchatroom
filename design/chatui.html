<html lang='zh-CN'>
        <head >
        <meta charset='UTF-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1.0'/>
<title >AI æ™ºèƒ½èŠå¤©å®¤</title>
<!-- å¼•å…¥ Tailwind CSS -->
<script src='https://res.gemcoder.com/js/reload.js'></script>
<script src='https://cdn.tailwindcss.com'></script>
<!-- å¼•å…¥ Font Awesome -->
<link rel='stylesheet' href='https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css'/>
<style >
        /* è‡ªå®šä¹‰æ·±è‰²èƒŒæ™¯å’Œæ¸å˜æ•ˆæœï¼Œå‚è€ƒå›¾ç‰‡æ¨¡æ¿ */
        body {
            background-color: #0a0a1a; /* æ·±è“è‰²èƒŒæ™¯ */
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }
        /* æ¨¡æ‹Ÿå›¾ç‰‡æ¨¡æ¿ä¸­çš„äº®è“è‰² */
        .text-ai-blue {
            color: #3b82f6; /* blue-500 */
        }
        .bg-ai-blue {
            background-color: #3b82f6; /* blue-500 */
        }
        .hover\:bg-ai-blue:hover {
            background-color: #2563eb; /* blue-600 */
        }
        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .chat-message {
            max-width: 80%;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #1f2937; /* dark gray track */
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray thumb */
            border-radius: 4px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
    </head>
<body class='min-h-screen flex antialiased'>
        <!-- ä¸»å®¹å™¨ -->
<div id='app-container' class='flex w-full h-screen overflow-hidden'>
        <!-- ä¾§è¾¹æ ï¼šæˆ¿é—´åˆ—è¡¨å’Œç”¨æˆ·åˆ—è¡¨ -->
<!-- [MODULE] 4aB_ä¾§è¾¹æ  -->
<aside id='sidebar' class='w-64 bg-gray-900/70 border-r border-gray-700 flex flex-col p-4 shadow-2xl'>
        <!-- [MODULE] 4aB_ä¾§è¾¹æ :åº”ç”¨æ ‡é¢˜ -->
<div class='mb-6 pb-3 border-b border-gray-700'>
        <h1 class='text-2xl font-bold text-white'>
        <span class='text-ai-blue'>
        AI
    </span>
Chat
    </h1>
<p class='text-xs text-gray-400 mt-1'>
        Local Dev Mode
    </p>
    </div>
<!-- [/MODULE] 4aB_ä¾§è¾¹æ :åº”ç”¨æ ‡é¢˜ -->
<!-- [MODULE] 4aB_ä¾§è¾¹æ :æˆ¿é—´åˆ—è¡¨ -->
<div class='mb-6'>
        <h2 class='text-sm font-semibold text-gray-300 mb-2 flex items-center'>
        <i class='fas fa-users mr-2 text-ai-blue'>
        </i>
èŠå¤©æˆ¿é—´
    </h2>
<div id='room-list' class='space-y-2 text-sm'>
        <!-- æˆ¿é—´é¡¹ -->
<div class='room-item p-2 rounded-lg cursor-pointer transition duration-150 bg-gray-700/50 border border-ai-blue/50' data-room-id='general'>
        <i class='fas fa-hashtag mr-2 text-gray-400'>
        </i>
<span class='font-medium text-white'>
        # General Chat
    </span>
<span class='float-right text-xs bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center'>
        3
    </span>
    </div>
<div class='room-item p-2 rounded-lg cursor-pointer hover:bg-gray-700/30 transition duration-150' data-room-id='ai-dev'>
        <i class='fas fa-hashtag mr-2 text-gray-400'>
        </i>
<span class='font-medium'>
        # AI Development
    </span>
    </div>
<div class='room-item p-2 rounded-lg cursor-pointer hover:bg-gray-700/30 transition duration-150' data-room-id='music'>
        <i class='fas fa-hashtag mr-2 text-gray-400'>
        </i>
<span class='font-medium'>
        # Music & Fun
    </span>
    </div>
    </div>
<button class='mt-3 w-full text-xs text-gray-400 hover:text-ai-blue transition flex items-center justify-center p-1 border border-dashed border-gray-700 rounded-md hover:border-ai-blue/50'>
        <i class='fas fa-plus mr-1'>
        </i>
åˆ›å»ºæ–°æˆ¿é—´
    </button>
    </div>
<!-- [/MODULE] 4aB_ä¾§è¾¹æ :æˆ¿é—´åˆ—è¡¨ -->
<!-- [MODULE] 4aB_ä¾§è¾¹æ :ç”¨æˆ·åˆ—è¡¨ -->
<div >
        <h2 class='text-sm font-semibold text-gray-300 mb-2 flex items-center'>
        <i class='fas fa-user-friends mr-2 text-ai-blue'>
        </i>
åœ¨çº¿ç”¨æˆ· (5)
    </h2>
<div id='user-list' class='space-y-2 text-sm overflow-y-auto max-h-40'>
        <!-- ç”¨æˆ·é¡¹ -->
<div class='flex items-center p-1 rounded-lg hover:bg-gray-700/30 transition duration-150'>
        <div class='relative'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/a36d0ecd9f2c6eb5b1d0d8c346f85d87.png' class='w-8 h-8 rounded-full object-cover mr-2 border border-green-500' alt='User Avatar'/>
<span class='absolute bottom-0 right-1 block h-2 w-2 rounded-full ring-2 ring-gray-900 bg-green-500'>
        </span>
    </div>
<span class='font-medium text-white truncate'>
        You (Admin)
    </span>
    </div>
<div class='flex items-center p-1 rounded-lg hover:bg-gray-700/30 transition duration-150'>
        <div class='relative'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/9ed0ddaf94c5e83f968682293cd6cd01.png' class='w-8 h-8 rounded-full object-cover mr-2 border border-gray-700' alt='User Avatar'/>
<span class='absolute bottom-0 right-1 block h-2 w-2 rounded-full ring-2 ring-gray-900 bg-yellow-500'>
        </span>
    </div>
<span class='font-medium'>
        Alice_Dev
    </span>
    </div>
<div class='flex items-center p-1 rounded-lg hover:bg-gray-700/30 transition duration-150'>
        <div class='relative'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/cf266fa96ce5f14417a5ce9a878c98e4.png' class='w-8 h-8 rounded-full object-cover mr-2 border border-gray-700' alt='User Avatar'/>
<span class='absolute bottom-0 right-1 block h-2 w-2 rounded-full ring-2 ring-gray-900 bg-green-500'>
        </span>
    </div>
<span class='font-medium'>
        Bob_Coder
    </span>
    </div>
<div class='flex items-center p-1 rounded-lg hover:bg-gray-700/30 transition duration-150'>
        <div class='relative'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/53de0e9d96f47ac0c4fa377668e8840d.png' class='w-8 h-8 rounded-full object-cover mr-2 border border-gray-700' alt='User Avatar'/>
<span class='absolute bottom-0 right-1 block h-2 w-2 rounded-full ring-2 ring-gray-900 bg-gray-500'>
        </span>
    </div>
<span class='font-medium'>
        Guest_User
    </span>
    </div>
    </div>
    </div>
<!-- [/MODULE] 4aB_ä¾§è¾¹æ :ç”¨æˆ·åˆ—è¡¨ -->
    </aside>
<!-- [/MODULE] 4aB_ä¾§è¾¹æ  -- åŒ…å«æˆ¿é—´åˆ—è¡¨å’Œç”¨æˆ·åˆ—è¡¨ï¼Œç”¨äºå¯¼èˆªå’ŒçŠ¶æ€å±•ç¤º -->
<!-- ä¸»å†…å®¹åŒºåŸŸï¼šèŠå¤©ç•Œé¢ -->
<!-- [MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢ -->
<main class='flex-1 flex flex-col bg-gray-900/50 relative'>
        <!-- é¡¶éƒ¨ï¼šæˆ¿é—´ä¿¡æ¯å’Œæ“ä½œ -->
<!-- [MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:é¡¶éƒ¨æ ‡é¢˜æ  -->
<header class='p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50 shadow-lg z-10'>
        <div class='flex items-center'>
        <i class='fas fa-hashtag mr-2 text-ai-blue text-xl'>
        </i>
<h2 id='current-room-name' class='text-xl font-semibold text-white'>
        # General Chat
    </h2>
<span class='ml-3 text-sm text-gray-400 border border-gray-600 px-2 py-0.5 rounded-full'>
        5 Members
    </span>
    </div>
<div class='flex space-x-3'>
        <button title='AI åŠ©æ‰‹è®¾ç½®' class='text-gray-400 hover:text-ai-blue transition p-2 rounded-full hover:bg-gray-700'>
        <i class='fas fa-robot'>
        </i>
    </button>
<button title='æœç´¢' class='text-gray-400 hover:text-ai-blue transition p-2 rounded-full hover:bg-gray-700'>
        <i class='fas fa-search'>
        </i>
    </button>
<button title='æ›´å¤šé€‰é¡¹' class='text-gray-400 hover:text-ai-blue transition p-2 rounded-full hover:bg-gray-700'>
        <i class='fas fa-ellipsis-v'>
        </i>
    </button>
    </div>
    </header>
<!-- [/MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:é¡¶éƒ¨æ ‡é¢˜æ  -->
<!-- èŠå¤©çª—å£ -->
<!-- [MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:æ¶ˆæ¯å±•ç¤ºåŒº -->
<div id='chat-window' class='flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar'>
        <!-- æ¬¢è¿/ç³»ç»Ÿæ¶ˆæ¯ -->
<div class='text-center text-sm text-gray-400 pt-4'>
        <div class='inline-block bg-gray-800/50 px-4 py-2 rounded-xl shadow-lg border border-gray-700'>
        <i class='fas fa-robot mr-2 text-ai-blue'>
        </i>
æ¬¢è¿æ¥åˆ° # General Chatã€‚æ‚¨å·²ç™»å½•ã€‚
    </div>
    </div>
<!-- ç¤ºä¾‹æ¶ˆæ¯ï¼šç”¨æˆ·å‘é€ -->
<div class='flex justify-end'>
        <div class='chat-message bg-ai-blue text-white p-3 rounded-tl-xl rounded-tr-xl rounded-bl-xl shadow-lg'>
        <div class='flex items-center mb-1'>
        <span class='font-bold mr-2'>
        You
    </span>
<span class='text-xs text-white/70'>
        10:30 AM
    </span>
    </div>
<p >
        å¤§å®¶å¥½ï¼Œæˆ‘ä»¬ä»Šå¤©å¼€å§‹æœ¬åœ°AIå¼€å‘æ¨¡å¼çš„æµ‹è¯•ï¼
    </p>
    </div>
    </div>
<!-- ç¤ºä¾‹æ¶ˆæ¯ï¼šAIå›å¤ -->
<div class='flex justify-start'>
        <div class='flex items-start space-x-3'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/72713b3a1045ecaf9955811de47d1d45.png' class='w-10 h-10 rounded-full object-cover mt-1 border border-ai-blue' alt='AI Avatar'/>
<div class='chat-message bg-gray-700/70 text-white p-3 rounded-tr-xl rounded-bl-xl rounded-br-xl shadow-lg'>
        <div class='flex items-center mb-1'>
        <span class='font-bold text-ai-blue mr-2'>
        AI Assistant
    </span>
<span class='text-xs text-gray-300/70'>
        10:31 AM
    </span>
    </div>
<p >
        å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼æˆ‘å·²ç»å‡†å¤‡å¥½è¿›è¡Œæœ¬åœ°AIå¼€å‘æ¨¡å¼çš„ä½“éªŒã€‚è¯·é—®æœ‰ä»€ä¹ˆéœ€è¦æˆ‘ååŠ©æ„å»ºçš„å—ï¼Ÿ
    </p>
<!-- AI ç‰¹æ®ŠåŠŸèƒ½å›å¤ -->
<div class='mt-2 pt-2 border-t border-gray-600/50 text-sm'>
        <p class='text-gray-300'>
        <i class='fas fa-music mr-1 text-pink-400'>
        </i>
æ­£åœ¨å¤„ç† @éŸ³ä¹ è¯·æ±‚... ğŸµ
    </p>
    </div>
    </div>
    </div>
    </div>
<!-- ç¤ºä¾‹æ¶ˆæ¯ï¼š@ç”¨æˆ· -->
<div class='flex justify-start'>
        <div class='flex items-start space-x-3'>
        <img src='https://design.gemcoder.com/staticResource/echoAiSystemImages/08a85b0d22fbb7b9ab370be18192c92c.png' class='w-10 h-10 rounded-full object-cover mt-1 border border-gray-700' alt='User Avatar'/>
<div class='chat-message bg-gray-700/70 text-white p-3 rounded-tr-xl rounded-bl-xl rounded-br-xl shadow-lg'>
        <div class='flex items-center mb-1'>
        <span class='font-bold mr-2 text-red-400'>
        Alice_Dev
    </span>
<span class='text-xs text-gray-300/70'>
        10:32 AM
    </span>
    </div>
<p >
        @You çœ‹çœ‹è¿™ä¸ªè®¾è®¡ï¼Œæ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ
<i class='fas fa-grin-stars text-yellow-400'>
        </i>
    </p>
    </div>
    </div>
    </div>
<!-- ç¤ºä¾‹æ¶ˆæ¯ï¼šè¡¨æƒ… -->
<div class='flex justify-end'>
        <div class='chat-message bg-ai-blue text-white p-3 rounded-tl-xl rounded-tr-xl rounded-bl-xl shadow-lg'>
        <div class='flex items-center mb-1'>
        <span class='font-bold mr-2'>
        You
    </span>
<span class='text-xs text-white/70'>
        10:33 AM
    </span>
    </div>
<div class='text-3xl'>
        ğŸ‘ğŸ‰
    </div>
    </div>
    </div>
<!-- å ä½ç¬¦ï¼Œç”¨äºç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨ -->
<div id='chat-bottom-anchor'>
        </div>
    </div>
<!-- [/MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:æ¶ˆæ¯å±•ç¤ºåŒº -->
<!-- è¾“å…¥åŒºåŸŸ -->
<!-- [MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:è¾“å…¥æ¡† -->
<div class='p-4 border-t border-gray-700 bg-gray-800/70 shadow-inner'>
        <!-- è¡¨æƒ…é€‰æ‹©å™¨å ä½ -->
<div id='emoji-picker-container' class='hidden mb-2 p-2 bg-gray-700 rounded-lg border border-gray-600'>
        <!-- å®é™…è¡¨æƒ…åˆ—è¡¨å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
<div class='flex flex-wrap gap-2 text-2xl'>
        <span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸ˜€'>
        ğŸ˜€
    </span>
<span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸ˜‚'>
        ğŸ˜‚
    </span>
<span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸ˜'>
        ğŸ˜
    </span>
<span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸ¤”'>
        ğŸ¤”
    </span>
<span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸš€'>
        ğŸš€
    </span>
<span class='cursor-pointer hover:scale-110 transition' data-emoji='ğŸ’¡'>
        ğŸ’¡
    </span>
    </div>
    </div>
<div class='flex items-end space-x-3'>
        <!-- è¡¨æƒ…æŒ‰é’® -->
<button id='emoji-toggle-btn' title='å‘é€è¡¨æƒ…' class='p-3 text-gray-400 hover:text-yellow-400 transition rounded-full hover:bg-gray-700 h-12 w-12 flex items-center justify-center flex-shrink-0'>
        <i class='fas fa-smile text-xl'>
        </i>
    </button>
<!-- è¾“å…¥æ¡† -->
<div class='flex-1 relative'>
        <textarea id='message-input' placeholder='è¾“å…¥æ¶ˆæ¯ï¼Œæ”¯æŒ @éŸ³ä¹, @ç”µå½± æˆ–ç›´æ¥ä¸AIå¯¹è¯...' rows='1' class='w-full p-3 pr-12 bg-gray-700/80 text-white border border-gray-600 rounded-xl focus:ring-2 focus:ring-ai-blue focus:border-ai-blue resize-none overflow-hidden transition duration-150 placeholder-gray-400' style='min-height: 3rem; max-height: 10rem;'>
        </textarea>
<!-- æåŠ/å‘½ä»¤æç¤º -->
<div id='mention-suggestion' class='absolute bottom-full left-0 mb-1 hidden w-48 bg-gray-800 border border-gray-600 rounded-lg shadow-xl p-1 text-sm z-20'>
        <!-- åŠ¨æ€ç”Ÿæˆ @ç”¨æˆ· æˆ– @åŠŸèƒ½ å»ºè®® -->
<div class='p-1 text-gray-300 hover:bg-gray-700 cursor-pointer rounded' data-mention='@AI'>
        @AI (ä¸AIå¯¹è¯)
    </div>
<div class='p-1 text-gray-300 hover:bg-gray-700 cursor-pointer rounded' data-mention='@éŸ³ä¹'>
        @éŸ³ä¹ (è¯·æ±‚éŸ³ä¹æ¨è)
    </div>
<div class='p-1 text-gray-300 hover:bg-gray-700 cursor-pointer rounded' data-mention='@ç”µå½±'>
        @ç”µå½± (è¯·æ±‚ç”µå½±æ¨è)
    </div>
    </div>
    </div>
<!-- å‘é€æŒ‰é’® -->
<button id='send-btn' class='bg-ai-blue text-white p-3 rounded-xl hover:bg-blue-600 transition duration-200 flex items-center justify-center h-12 w-12 flex-shrink-0 disabled:bg-gray-600 disabled:cursor-not-allowed' title='å‘é€æ¶ˆæ¯'>
        <i class='fas fa-paper-plane'>
        </i>
    </button>
    </div>
    </div>
<!-- [/MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢:è¾“å…¥æ¡† -->
    </main>
<!-- [/MODULE] 8cE_èŠå¤©ä¸»ç•Œé¢ -- åŒ…å«èŠå¤©çª—å£å’Œè¾“å…¥åŒºåŸŸ -->
    </div>
<!-- [JSMOD] app_main_logic -->
<script >// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¸²æŸ“
document.addEventListener('DOMContentLoaded', function () {
  var messageInput = document.getElementById('message-input');
  var sendBtn = document.getElementById('send-btn');
  var chatWindow = document.getElementById('chat-window');
  var emojiToggleBtn = document.getElementById('emoji-toggle-btn');
  var emojiPickerContainer = document.getElementById('emoji-picker-container');
  var mentionSuggestion = document.getElementById('mention-suggestion');
  var chatBottomAnchor = document.getElementById('chat-bottom-anchor');
  // --- 1. åŸºç¡€åŠŸèƒ½ï¼šå‘é€æ¶ˆæ¯ä¸DOMæ“ä½œ ---
  /**
   * è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦
   */
  function autoResizeTextarea() {
    messageInput.style.height = 'auto';
    messageInput.style.height = messageInput.scrollHeight + 'px';
    // é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢è¿‡é«˜
    var maxHeight = parseFloat(getComputedStyle(messageInput).maxHeight);
    if (messageInput.scrollHeight > maxHeight) {
      messageInput.style.overflowY = 'auto';
    } else {
      messageInput.style.overflowY = 'hidden';
    }
  }
  messageInput.addEventListener('input', function () {
    autoResizeTextarea();
    checkMentionsAndCommands();
    updateSendButtonState();
  });
  // åˆå§‹è°ƒæ•´é«˜åº¦
  autoResizeTextarea();
  /**
   * æ»šåŠ¨åˆ°åº•éƒ¨
   */
  function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  /**
   * åˆ›å»ºå¹¶æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
   * @param {string} text - æ¶ˆæ¯å†…å®¹
   * @param {string} sender - å‘é€è€… ('user' æˆ– 'ai')
   * @param {string} [username='You'] - ç”¨æˆ·å
   */
  function addMessage(text, sender) {
    var username = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'You';
    var isUser = sender === 'user';
    var messageContainer = document.createElement('div');
    messageContainer.className = "flex".concat(isUser ? 'justify-end' : 'justify-start');
    var contentDiv = document.createElement('div');

    // æ ·å¼å¤„ç†
    var baseClasses = 'chat-message p-3 shadow-lg';
    var specificClasses;
    var nameColor = isUser ? 'text-white' : 'text-ai-blue';
    var timeColor = isUser ? 'text-white/70' : 'text-gray-300/70';
    var bgColor;
    if (isUser) {
      // ç”¨æˆ·æ¶ˆæ¯ï¼šè“è‰²èƒŒæ™¯ï¼Œåœ†è§’åœ¨å·¦ä¸Šã€å³ä¸Šã€å·¦ä¸‹
      bgColor = 'bg-ai-blue';
      specificClasses = 'rounded-tl-xl rounded-tr-xl rounded-bl-xl';
    } else {
      // AI/ä»–äººæ¶ˆæ¯ï¼šæ·±ç°èƒŒæ™¯ï¼Œåœ†è§’åœ¨å³ä¸Šã€å·¦ä¸‹ã€å³ä¸‹
      bgColor = 'bg-gray-700/70';
      specificClasses = 'rounded-tr-xl rounded-bl-xl rounded-br-xl';
    }
    contentDiv.className = "".concat(baseClasses, "").concat(bgColor, "text-white").concat(isUser ? '' : 'max-w-[80%]');
    var now = new Date();
    var timeString = now.toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit'
    });
    // æ¶ˆæ¯ç»“æ„
    contentDiv.innerHTML = "<div class=\"flex items-center mb-1\">\n                        <span class=\"font-bold mr-2".concat(nameColor, "\">").concat(username, "</span>\n                        <span class=\"text-xs").concat(timeColor, "\">").concat(timeString, "</span>\n                    </div>\n                    <p class=\"whitespace-pre-wrap\">").concat(formatMessageContent(text), "</p>");
    if (!isUser) {
      // AI æ¶ˆæ¯éœ€è¦å¤´åƒ
      var avatarImg = document.createElement('img');
      avatarImg.src = "https://design.gemcoder.com/staticResource/echoAiSystemImages/72713b3a1045ecaf9955811de47d1d45.png";
      avatarImg.className = 'w-10 h-10 rounded-full object-cover mt-1 border border-ai-blue';
      avatarImg.alt = 'AI Avatar';
      var wrapper = document.createElement('div');
      wrapper.className = 'flex items-start space-x-3';
      wrapper.appendChild(avatarImg);
      wrapper.appendChild(contentDiv);
      messageContainer.appendChild(wrapper);
    } else {
      messageContainer.appendChild(contentDiv);
    }
    chatWindow.insertBefore(messageContainer, chatBottomAnchor);
    scrollToBottom();
  }
  /**
   * æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œå¤„ç†è¡¨æƒ…å’Œç‰¹æ®Šå‘½ä»¤
   * @param {string} text 
   */
  function formatMessageContent(text) {
    var html = text;
    // 1. å¤„ç†è¡¨æƒ…ç¬¦å· (ç®€å•çš„æ›¿æ¢)
    var emojiMap = {
      'ğŸ‘': 'ğŸ‘',
      'ğŸ‰': 'ğŸ‰',
      'ğŸ˜€': 'ğŸ˜€',
      'ğŸ˜‚': 'ğŸ˜‚',
      'ğŸ˜': 'ğŸ˜',
      'ğŸ¤”': 'ğŸ¤”',
      'ğŸš€': 'ğŸš€',
      'ğŸ’¡': 'ğŸ’¡'
    };
    Object.keys(emojiMap).forEach(function (emoji) {
      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç¡®ä¿åªæ›¿æ¢å®Œæ•´çš„è¡¨æƒ…ç¬¦å·ï¼Œå¹¶ç”¨ span åŒ…è£¹ä»¥ä¿æŒæ ·å¼ä¸€è‡´æ€§
      var regex = new RegExp(escapeRegExp(emoji), 'g');
      html = html.replace(regex, "<span class=\"text-xl\">".concat(emoji, "</span>"));
    });
    // 2. å¤„ç† @ æåŠå’Œå‘½ä»¤ (é«˜äº®æ˜¾ç¤º)
    // åŒ¹é… @AI, @éŸ³ä¹, @ç”µå½± ç­‰
    html = html.replace(/(@(AI|éŸ³ä¹|ç”µå½±|[\w]+))/g, function (match) {
      if (match === '@AI') {
        return "<span class=\"font-bold text-ai-blue\">".concat(match, "</span>");
      } else if (match === '@éŸ³ä¹' || match === '@ç”µå½±') {
        var icon = match === '@éŸ³ä¹' ? '<i class="fas fa-music mr-1 text-pink-400"></i>' : '<i class="fas fa-film mr-1 text-red-400"></i>';
        return "<span class=\"font-bold text-yellow-300\">".concat(icon).concat(match, "</span>");
      }
      // å…¶ä»– @ ç”¨æˆ·å
      return "<span class=\"font-bold text-cyan-400\">".concat(match, "</span>");
    });
    return html;
  }
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
  }
  /**
   * æ¨¡æ‹Ÿ AI å›å¤
   * @param {string} userMessage 
   */
  function simulateAIResponse(userMessage) {
    var responseText = "æˆ‘æ”¶åˆ°äº†æ‚¨çš„æ¶ˆæ¯ã€‚";
    var hasSpecialAction = false;
    if (userMessage.includes('@AI') || userMessage.toLowerCase().includes('ai')) {
      responseText = "æ‚¨å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªæœ¬åœ°AIæ¨¡å‹ï¼Œä¸“æ³¨äºä»£ç ç”Ÿæˆå’Œé—®é¢˜è§£ç­”ã€‚è¯·é—®æ‚¨æƒ³æ„å»ºä»€ä¹ˆï¼Ÿ";
      hasSpecialAction = true;
    } else if (userMessage.includes('@éŸ³ä¹')) {
      responseText = "\u597D\u7684\uFF0C\u6B63\u5728\u4E3A\u60A8\u641C\u7D22\u672C\u5730\u97F3\u4E50\u5E93\u6216\u63A8\u8350\u4E00\u9996\u9002\u5408\u7F16\u7A0B\u7684\u80CC\u666F\u97F3\u4E50\u3002\n\uD83C\uDFB5 \u63A8\u8350: 'Synthwave Drive' - \u9002\u5408\u9AD8\u5F3A\u5EA6\u5F00\u53D1\uFF01";
      hasSpecialAction = true;
    } else if (userMessage.includes('@ç”µå½±')) {
      responseText = "\u6B63\u5728\u67E5\u8BE2\u60A8\u559C\u6B22\u7684\u7535\u5F71\u7C7B\u578B\uFF0C\u6216\u8005\u63A8\u8350\u4E00\u90E8\u7ECF\u5178\u79D1\u5E7B\u7247\u3002\n\uD83C\uDFAC \u63A8\u8350: \u300A\u94F6\u7FFC\u6740\u624B 2049\u300B - \u89C6\u89C9\u548C\u6C1B\u56F4\u90FD\u5F88\u68D2\u3002";
      hasSpecialAction = true;
    } else if (userMessage.includes('è¡¨æƒ…') || userMessage.includes('emoji')) {
      responseText = "æˆ‘çœ‹åˆ°æ‚¨æåˆ°äº†è¡¨æƒ…ã€‚æˆ‘æ”¯æŒå‘é€ç®€å•çš„Unicodeè¡¨æƒ…ç¬¦å·ã€‚ğŸ‘ğŸ‰";
    } else if (userMessage.length < 5) {
      responseText = "ä¿¡æ¯å¤ªçŸ­äº†ï¼Œè¯·æä¾›æ›´å¤šç»†èŠ‚ä»¥ä¾¿æˆ‘æ›´å¥½åœ°ååŠ©æ‚¨ã€‚";
    } else {
      responseText = "è¿™æ˜¯ä¸€ä¸ªåŸºäºæ‚¨è¾“å…¥å†…å®¹çš„æ¨¡æ‹Ÿå›å¤ã€‚åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæˆ‘ä¼šè°ƒç”¨æœ¬åœ°æ¨¡å‹è¿›è¡Œæ›´æ·±å…¥çš„åˆ†æå’Œç”Ÿæˆã€‚";
    }
    // æ¨¡æ‹Ÿå»¶è¿Ÿ
    setTimeout(function () {
      addMessage(responseText, 'ai');
    }, 500 + Math.random() * 1000);
  }
  /**
   * å¤„ç†å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   */
  function handleSendMessage() {
    var text = messageInput.value.trim();
    if (text === '') return;
    // 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage(text, 'user');
    // 2. æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
    messageInput.value = '';
    autoResizeTextarea();
    updateSendButtonState();

    // 3. æ£€æŸ¥å¹¶éšè—å»ºè®®æ¡†
    mentionSuggestion.classList.add('hidden');
    // 4. æ¨¡æ‹Ÿ AI å“åº”
    simulateAIResponse(text);
  }
  sendBtn.addEventListener('click', handleSendMessage);
  // å…è®¸æŒ‰ Enter å‘é€ (Shift+Enter æ¢è¡Œ)
  messageInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
      handleSendMessage();
    }
  });
  // --- 2. è¡¨æƒ…åŠŸèƒ½ ---
  emojiToggleBtn.addEventListener('click', function () {
    emojiPickerContainer.classList.toggle('hidden');
    // éšè—å»ºè®®æ¡†ï¼Œå¦‚æœæ‰“å¼€äº†è¡¨æƒ…æ¡†
    mentionSuggestion.classList.add('hidden');
  });
  // è¡¨æƒ…é€‰æ‹©
  emojiPickerContainer.querySelectorAll('span[data-emoji]').forEach(function (span) {
    span.addEventListener('click', function () {
      var emoji = this.getAttribute('data-emoji');
      messageInput.value += emoji;
      autoResizeTextarea();
      updateSendButtonState();
      // ä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹
      messageInput.focus();
    });
  });
  // ç‚¹å‡»è¾“å…¥æ¡†å¤–å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
  document.addEventListener('click', function (e) {
    if (!emojiPickerContainer.contains(e.target) && e.target !== emojiToggleBtn && !emojiToggleBtn.contains(e.target)) {
      emojiPickerContainer.classList.add('hidden');
    }
  });
  // --- 3. @ æåŠå’Œå‘½ä»¤åŠŸèƒ½ ---
  /**
   * æ£€æŸ¥è¾“å…¥å†…å®¹ï¼Œæ˜¾ç¤º/éšè— @ å»ºè®®æ¡†
   */
  function checkMentionsAndCommands() {
    var text = messageInput.value;
    var cursorPosition = messageInput.selectionStart;

    // æŸ¥æ‰¾å…‰æ ‡å‰æœ€åä¸€ä¸ª '@' ç¬¦å·çš„ä½ç½®
    var lastAtSymbolIndex = text.lastIndexOf('@', cursorPosition - 1);
    if (lastAtSymbolIndex !== -1) {
      var segment = text.substring(lastAtSymbolIndex + 1, cursorPosition).trim();
      if (segment.length > 0) {
        // è¿‡æ»¤å»ºè®®é¡¹
        var suggestions = Array.from(mentionSuggestion.querySelectorAll('[data-mention]')).filter(function (el) {
          return el.getAttribute('data-mention').toLowerCase().startsWith('@' + segment.toLowerCase());
        });
        if (suggestions.length > 0) {
          // ç®€å•å®šä½ï¼šå°†å»ºè®®æ¡†å®šä½åœ¨è¾“å…¥æ¡†ä¸‹æ–¹
          var rect = messageInput.getBoundingClientRect();
          mentionSuggestion.style.left = "".concat(rect.left, "px");
          mentionSuggestion.style.top = "".concat(rect.bottom + window.scrollY, "px");
          mentionSuggestion.classList.remove('hidden');
          // ç®€å•é«˜äº®ç¬¬ä¸€ä¸ªå»ºè®®é¡¹
          suggestions.forEach(function (el, index) {
            el.classList.toggle('bg-gray-600', index === 0);
          });
          return;
        }
      }
    }
    mentionSuggestion.classList.add('hidden');
  }
  /**
   * é€‰ä¸­å»ºè®®é¡¹
   */
  mentionSuggestion.querySelectorAll('[data-mention]').forEach(function (el) {
    el.addEventListener('click', function () {
      var mention = this.getAttribute('data-mention');
      var text = messageInput.value;
      var cursorPosition = messageInput.selectionStart;
      var lastAtSymbolIndex = text.lastIndexOf('@', cursorPosition - 1);
      if (lastAtSymbolIndex !== -1) {
        // æ›¿æ¢ä» @ å¼€å§‹åˆ°å½“å‰å…‰æ ‡å‰çš„æ‰€æœ‰å†…å®¹
        var prefix = text.substring(0, lastAtSymbolIndex);
        var suffix = text.substring(cursorPosition);

        // æ’å…¥æåŠå†…å®¹ï¼Œå¹¶ç¡®ä¿åé¢è·Ÿä¸€ä¸ªç©ºæ ¼ï¼Œé™¤éæ˜¯å‘½ä»¤
        messageInput.value = prefix + mention + "" + suffix;

        // é‡æ–°å®šä½å…‰æ ‡åˆ°æåŠå†…å®¹ä¹‹å
        var newCursorPosition = prefix.length + mention.length + 1;
        messageInput.setSelectionRange(newCursorPosition, newCursorPosition);
        autoResizeTextarea();
        mentionSuggestion.classList.add('hidden');
        messageInput.focus();
      }
    });
  });
  // ç›‘å¬è¾“å…¥æ¡†çš„ç„¦ç‚¹å˜åŒ–ï¼Œç”¨äºéšè—å»ºè®®æ¡†
  messageInput.addEventListener('focus', checkMentionsAndCommands);
  messageInput.addEventListener('blur', function () {
    // å»¶è¿Ÿéšè—ï¼Œç»™ç‚¹å‡»å»ºè®®é¡¹çš„æ—¶é—´
    setTimeout(function () {
      if (!mentionSuggestion.contains(document.activeElement)) {
        mentionSuggestion.classList.add('hidden');
      }
    }, 100);
  });

  // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶æ£€æŸ¥
  messageInput.addEventListener('keyup', checkMentionsAndCommands);
  // --- 4. ç•Œé¢çŠ¶æ€æ§åˆ¶ ---
  /**
   * æ›´æ–°å‘é€æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€
   */
  function updateSendButtonState() {
    var isEmpty = messageInput.value.trim() === '';
    sendBtn.disabled = isEmpty;
  }
  updateSendButtonState();
  // --- 5. æˆ¿é—´åˆ‡æ¢æ¨¡æ‹Ÿ ---
  document.querySelectorAll('.room-item').forEach(function (item) {
    item.addEventListener('click', function () {
      var roomId = this.getAttribute('data-room-id');
      var roomName = this.querySelector('span').textContent.trim();

      // è§†è§‰åé¦ˆï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.room-item').forEach(function (i) {
        i.classList.remove('bg-gray-700/50', 'border-ai-blue/50');
        i.classList.add('hover:bg-gray-700/30');
      });
      this.classList.add('bg-gray-700/50', 'border-ai-blue/50');
      this.classList.remove('hover:bg-gray-700/30');
      // æ›´æ–°ä¸»ç•Œé¢æ ‡é¢˜
      document.getElementById('current-room-name').textContent = roomName;

      // æ¨¡æ‹Ÿæ¸…ç©ºèŠå¤©è®°å½•å¹¶æ˜¾ç¤ºæ–°æˆ¿é—´æç¤º
      chatWindow.innerHTML = "<div class=\"text-center text-sm text-gray-400 pt-4\">\n                            <div class=\"inline-block bg-gray-800/50 px-4 py-2 rounded-xl shadow-lg border border-gray-700\">\n                                <i class=\"fas fa-hashtag mr-2 text-ai-blue\"></i> \u5DF2\u5207\u6362\u5230".concat(roomName, "\u623F\u95F4\u3002\n                            </div>\n                        </div>\n                        <div id=\"chat-bottom-anchor\"></div>");
      scrollToBottom();
    });
  });
  // åˆå§‹æ»šåŠ¨åˆ°åº•éƒ¨
  scrollToBottom();
});</script>
<!-- [/JSMOD] app_main_logic -- åŒ…å«èŠå¤©æ¶ˆæ¯å‘é€ã€AIæ¨¡æ‹Ÿå›å¤ã€è¡¨æƒ…æ”¯æŒã€@åŠŸèƒ½æç¤ºå’Œæˆ¿é—´åˆ‡æ¢é€»è¾‘ -->
    </body>
    </html>